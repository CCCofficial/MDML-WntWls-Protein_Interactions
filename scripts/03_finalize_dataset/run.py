import sys
from scripts.util.distances import *
import os
import argparse
import re

parser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter, description='''
-------------------------------------------------------------------------------------------------
Apply the distance threshhold to the dataset generated by 01_get_contact_matrix/run.py
---------------------------------------------------------------------------------------------------------------------
Example Command: python3 run.py -sys 5a -cutoff 12 -dir . -dt 20 -tf 1500000
---------------------------------------------------------------------------------------------------------------------''')
parser.add_argument('-sys', dest = 'SYSTEM', help='Wnt system directory (from box)', type=str, required=True)
parser.add_argument('-cutoff', dest = 'distance_threshhold', help='Cutoff for contacts (in angstroms)', type=int, required=True)
parser.add_argument('-dir', dest = 'workingDir', help='Working directory - used to store results', type=str, required=True)
parser.add_argument('-dt', dest = 'timestep', help='saving frequency (in ps)', type=int, required=True)
parser.add_argument('-tf', dest = 'tFinal', help='Trajectory time to read in (in ps)', type=int, required=True)
args = parser.parse_args()

SYSTEM = args.SYSTEM
distance_threshhold = args.distance_threshhold
workingDir = args.workingDir
timestep = args.timestep
tFinal =args.tFinal
nFrames = int(tFinal/timestep)

dcd_names = [i for i in sorted(os.listdir(f"{workingDir}/01_get_contact_matrix/output")) if f"WNT{SYSTEM}" in str(i) and ".npy" in str(i)]
idx_arr = np.array([re.findall(rf'\d+', i) for i in dcd_names])
dcd_names = list(np.array(dcd_names)[np.argsort(idx_arr[:,1].astype(int))])
print(dcd_names)

idx = np.loadtxt(f"{workingDir}/02_apply_threshhold/output/WNT{SYSTEM}_idx_thresh{distance_threshhold}.txt", dtype=int)
currFrame = 0
final = np.zeros((nFrames,len(idx)))

for i in range(len(dcd_names)):
    curr = np.load(f"{workingDir}/01_get_contact_matrix/output/{dcd_names[i]}", mmap_mode='r')[:, idx].copy()
    print(np.shape(curr), currFrame, nFrames)

    if currFrame < nFrames and currFrame + int(curr.shape[0]) >= nFrames:
        print(f"Number of frames currently read in: {currFrame} ({currFrame*20/1000} ns) -> Ending at {currFrame+int(nFrames - currFrame)} ({(currFrame+int(nFrames - currFrame))*20/1000} ns)")
        final[currFrame:, :] = curr[:int(nFrames - currFrame)]
        break

    elif currFrame < nFrames:
        print(f"Number of frames read in: {currFrame} ({currFrame*20/1000} ns)")
        final[currFrame:currFrame + int(curr.shape[0]), :] = curr

    currFrame += int(curr.shape[0])

resnames = np.loadtxt(f"{workingDir}/01_get_contact_matrix/output/WNT{SYSTEM}_resids.txt", dtype=str)[idx]

np.save(f"{workingDir}/03_finalize_dataset/output/WNT{SYSTEM}_threshhold{distance_threshhold}_matrix.npy", final)
np.savetxt(f"{workingDir}/03_finalize_dataset/output/WNT{SYSTEM}_threshhold{distance_threshhold}_labels.txt", resnames, fmt='%s')

